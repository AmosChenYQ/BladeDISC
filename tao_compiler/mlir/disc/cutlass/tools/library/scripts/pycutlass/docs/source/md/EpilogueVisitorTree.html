

<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Epilogue Visitor Tree &mdash; BladeDISC 1.0.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../../../../../../../../../../_static/css/theme.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../../../../../../../_static/css/custom.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../../../../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../../../../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../../../../../../../_static/css/theme.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../../../../../../../_static/copybutton.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../../../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../../../../../../search.html" /> 

</head>

<body>
    <header>
        <div class="container">
            <a class="site-nav-toggle hidden-lg-up"><i class="icon-menu"></i></a>
            <a class="site-title" href="../../../../../../../../../../../index.html">
                BladeDISC
            </a>
        </div>
    </header>


<div class="breadcrumbs-outer hidden-xs-down">
    <div class="container">
        















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="breadcrumbs">
    
      <li><a href="../../../../../../../../../../../index.html">Docs</a></li>
        
      <li>Epilogue Visitor Tree</li>
    
    
      <li class="breadcrumbs-aside">
        
            
            <a href="../../../../../../../../../../../_sources/tao_compiler/mlir/disc/cutlass/tools/library/scripts/pycutlass/docs/source/md/EpilogueVisitorTree.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>
</div>
    </div>
</div>
    <div class="main-outer">
        <div class="container">
            <div class="row">
                <div class="col-12 col-lg-3 site-nav">
                    
<div role="search">
    <form class="search" action="../../../../../../../../../../../search.html" method="get">
        <div class="icon-input">
            <input type="text" name="q" placeholder="Search" />
            <span class="icon-search"></span>
        </div>
        <input type="submit" value="Go" class="d-hidden" />
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
    </form>
</div>
                    <div class="site-nav-tree">
                        
                            
                            
                                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../../../../../README.html">BladeDISC Overview</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../../../../../../../../README.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../../../../../../../README.html#api-quickview">API QuickView</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../../../../../../../README.html#setup-and-examples">Setup and Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../../../../../../../README.html#publications">Publications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../../../../../../../README.html#tutorials-and-documents-for-developers">Tutorials and Documents for Developers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../../../../../../../README.html#presentations-and-talks">Presentations and Talks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../../../../../../../README.html#how-to-contribute">How to Contribute</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../../../../../../../README.html#building-status">Building Status</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../../../../../../../README.html#faq">FAQ</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../../../../../../../README.html#contact-us">Contact Us</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../../../../../docs/install_with_docker.html">Install with Docker</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../../../../../../../../docs/install_with_docker.html#download-a-bladedisc-docker-image">Download a BladeDISC Docker Image</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../../../../../../../docs/install_with_docker.html#start-a-docker-container">Start a Docker Container</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../../../../../docs/build_from_source.html">Build from Source</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../../../../../../../../docs/build_from_source.html#prerequisite">Prerequisite</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../../../../../../../docs/build_from_source.html#checkout-the-source">Checkout the Source</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../../../../../../../docs/build_from_source.html#launch-a-development-docker-container">Launch a development Docker container</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../../../../../../../docs/build_from_source.html#building-bladedisc-for-tensorflow-users">Building BladeDISC for TensorFlow Users</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../../../../../../../docs/build_from_source.html#building-bladedisc-for-pytorch-users">Building BladeDISC for PyTorch Users</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../../../../../docs/quickstart.html">Quickstart</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../../../../../../../../docs/quickstart.html#quickstart-for-tensorflow-users">Quickstart for TensorFlow Users</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../../../../../../../docs/quickstart.html#quickstart-for-pytorch-users">Quickstart for PyTorch Users</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../../../../../docs/contribution.html">How to Contribute</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../../../../../../../../docs/contribution.html#local-development-environment">Local Development Environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../../../../../../../docs/contribution.html#submit-a-pull-request-to-bladedisc">Submit a Pull Request to BladeDISC</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../../../../../docs/tutorials/index.html">Tutorials on Example Use Cases</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../../../../../../../../docs/tutorials/tensorflow_inference_and_training.html">Use case of TensorFlow Inference and Training</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../../../../../../../docs/tutorials/torch_bert_inference.html">Use case of PyTorch Inference</a></li>
</ul>
</li>
</ul>

                            
                        
                    </div>
                </div>
                <div class="col-12 col-lg-9">
                    <div class="document">
                        
                            
  <section id="epilogue-visitor-tree">
<h1>Epilogue Visitor Tree<a class="headerlink" href="#epilogue-visitor-tree" title="Permalink to this heading">¶</a></h1>
<p>The Epilogue Visitor Tree is an experimental feature that directly generates epilogues from user-provide python functions.</p>
<section id="usage">
<h2>Usage<a class="headerlink" href="#usage" title="Permalink to this heading">¶</a></h2>
<p>The Epilogue Visitor tree support many different operations.</p>
<section id="unary-functions">
<h3>Unary functions<a class="headerlink" href="#unary-functions" title="Permalink to this heading">¶</a></h3>
<p>Epilogue Visitor Tree supports unary functions like activation functions. For example,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">UnaryEpilogue_</span><span class="p">(</span><span class="n">EpilogueVisitTree</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">accum</span><span class="p">:</span> <span class="s1">&#39;tensor&#39;</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="s1">&#39;tensor&#39;</span><span class="p">,</span> 
        <span class="n">alpha</span><span class="p">:</span> <span class="s1">&#39;scalar&#39;</span><span class="p">,</span> <span class="n">beta</span><span class="p">:</span> <span class="s1">&#39;scalar&#39;</span><span class="p">):</span>
        <span class="c1">#</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">leaky_relu</span><span class="o">.</span><span class="n">numpy</span><span class="p">(</span><span class="n">accum</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">T</span> <span class="o">+</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">c</span>
        <span class="k">return</span> <span class="n">Z</span>
<span class="n">epilogue_functor</span> <span class="o">=</span> <span class="n">UnaryEpilogue_</span><span class="p">(</span>
    <span class="n">epilogue_functor</span><span class="p">,</span> <span class="n">tile_description</span><span class="p">,</span> <span class="n">math_inst</span><span class="o">.</span><span class="n">element_accumulator</span><span class="p">,</span> 
    <span class="n">C</span><span class="o">.</span><span class="n">alignment</span><span class="p">,</span> <span class="n">element_epilogue</span><span class="p">,</span> <span class="n">C</span><span class="o">.</span><span class="n">element</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="broadcast-operation">
<h3>Broadcast Operation<a class="headerlink" href="#broadcast-operation" title="Permalink to this heading">¶</a></h3>
<p>Epilogue Visitor Tree supports broadcasting row and column vectors to the whole output matrix. To use broadcast, you just need to specify whether the source vector is a <code class="docutils literal notranslate"><span class="pre">row</span></code> vector or a <code class="docutils literal notranslate"><span class="pre">column</span></code> vector. Here is an example.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ColumnBroadcast_</span><span class="p">(</span><span class="n">EpilogueVisitTree</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">accum</span><span class="p">:</span> <span class="s1">&#39;tensor&#39;</span><span class="p">,</span>  <span class="n">c</span><span class="p">:</span> <span class="s1">&#39;tensor&#39;</span><span class="p">,</span> 
        <span class="n">vector</span><span class="p">:</span> <span class="s1">&#39;column&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="s1">&#39;scalar&#39;</span><span class="p">,</span> <span class="n">beta</span><span class="p">:</span> <span class="s1">&#39;scalar&#39;</span><span class="p">):</span>
        <span class="c1">#</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">accum</span> <span class="o">+</span> <span class="n">vector</span>
        <span class="n">scale_T</span> <span class="o">=</span> <span class="n">leaky_relu</span><span class="o">.</span><span class="n">numpy</span><span class="p">(</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">T</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="n">scale_T</span> <span class="o">+</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">c</span>
        <span class="k">return</span> <span class="n">Z</span><span class="p">,</span> <span class="n">T</span>
<span class="n">epilogue_functor</span> <span class="o">=</span> <span class="n">ColumnBroadcast_</span><span class="p">(</span>
    <span class="n">epilogue_functor</span><span class="p">,</span> <span class="n">tile_description</span><span class="p">,</span> <span class="n">math_inst</span><span class="o">.</span><span class="n">element_accumulator</span><span class="p">,</span> 
    <span class="n">C</span><span class="o">.</span><span class="n">alignment</span><span class="p">,</span> <span class="n">element_epilogue</span><span class="p">,</span> <span class="n">C</span><span class="o">.</span><span class="n">element</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="reduction-operation">
<h3>Reduction Operation<a class="headerlink" href="#reduction-operation" title="Permalink to this heading">¶</a></h3>
<p>Epilogue Visitor Tree also supports row and column-wise reduction in each threadblock tile. The syntax for reduction is</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">reduction_output</span><span class="p">}</span> <span class="o">=</span> <span class="n">reduction_op</span><span class="p">({</span><span class="n">input_tensor</span><span class="p">},</span> <span class="p">{</span><span class="n">row</span><span class="o">|</span><span class="n">column</span><span class="p">},</span> <span class="p">{</span><span class="n">Add</span><span class="p">},</span> <span class="p">{</span><span class="n">threadblock_shape</span><span class="o">.</span><span class="n">n</span><span class="o">|</span><span class="n">threadblock_shape</span><span class="o">.</span><span class="n">m</span><span class="p">})</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">{row|column}</span></code> indicates whether the <code class="docutils literal notranslate"><span class="pre">row</span></code> vectors are reduced or the <code class="docutils literal notranslate"><span class="pre">column</span></code> vectors are reduction. The <code class="docutils literal notranslate"><span class="pre">{Add}</span></code> specifies the reduction operation. The <code class="docutils literal notranslate"><span class="pre">{threadblock_shape.n|threadblock_shape.m}</span></code> are the reduction lengths.</p>
<p><strong>Constraint</strong></p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">{input_tensor}</span></code> can only be the name of source or intermediate result. <code class="docutils literal notranslate"><span class="pre">reduction_op(A</span> <span class="pre">+</span> <span class="pre">B,</span> <span class="pre">...)</span></code> will not work, please use <code class="docutils literal notranslate"><span class="pre">C</span> <span class="pre">=</span> <span class="pre">A</span> <span class="pre">+</span> <span class="pre">B</span></code>, <code class="docutils literal notranslate"><span class="pre">reduction_op(C,</span> <span class="pre">...)</span></code> instead.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">{reduction_output}</span></code> cannot be used in the epilogue. It will be directly written to global memory after the reduction is done.</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">RowReduction_</span><span class="p">(</span><span class="n">EpilogueVisitTree</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">accum</span><span class="p">:</span> <span class="s1">&#39;tensor&#39;</span><span class="p">,</span>  <span class="n">c</span><span class="p">:</span> <span class="s1">&#39;tensor&#39;</span><span class="p">,</span> 
        <span class="n">alpha</span><span class="p">:</span> <span class="s1">&#39;scalar&#39;</span><span class="p">,</span> <span class="n">beta</span><span class="p">:</span> <span class="s1">&#39;scalar&#39;</span><span class="p">):</span>
        <span class="c1">#</span>
        <span class="n">D</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">accum</span> <span class="o">+</span> <span class="n">tanh</span><span class="o">.</span><span class="n">numpy</span><span class="p">(</span><span class="n">beta</span> <span class="o">*</span> <span class="n">c</span><span class="p">)</span>
        <span class="n">reduction</span> <span class="o">=</span> <span class="n">reduction_op</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="s2">&quot;row&quot;</span><span class="p">,</span> <span class="s2">&quot;Add&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">threadblock_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">D</span><span class="p">,</span> <span class="n">reduction</span>
<span class="n">epilogue_functor</span> <span class="o">=</span> <span class="n">RowReduction_</span><span class="p">(</span>
    <span class="n">epilogue_functor</span><span class="p">,</span> <span class="n">tile_description</span><span class="p">,</span> <span class="n">math_inst</span><span class="o">.</span><span class="n">element_accumulator</span><span class="p">,</span> 
    <span class="n">C</span><span class="o">.</span><span class="n">alignment</span><span class="p">,</span> <span class="n">element_epilogue</span><span class="p">,</span> <span class="n">C</span><span class="o">.</span><span class="n">element</span><span class="p">)</span>
<span class="n">epilogue_functor</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>
<section id="get-output-op">
<h2>Get output_op<a class="headerlink" href="#get-output-op" title="Permalink to this heading">¶</a></h2>
<p>As shown in the user guide, an <code class="docutils literal notranslate"><span class="pre">output_op</span></code> is required by the argument wrapper. We will take the <code class="docutils literal notranslate"><span class="pre">RowReduction_</span></code> as an example to show how to get <code class="docutils literal notranslate"><span class="pre">output_op</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">RowReduction_</span><span class="p">(</span><span class="n">EpilogueVisitTree</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">accum</span><span class="p">:</span> <span class="s1">&#39;tensor&#39;</span><span class="p">,</span>  <span class="n">c</span><span class="p">:</span> <span class="s1">&#39;tensor&#39;</span><span class="p">,</span> 
        <span class="n">alpha</span><span class="p">:</span> <span class="s1">&#39;scalar&#39;</span><span class="p">,</span> <span class="n">beta</span><span class="p">:</span> <span class="s1">&#39;scalar&#39;</span><span class="p">):</span>
        <span class="c1">#</span>
        <span class="n">D</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">accum</span> <span class="o">+</span> <span class="n">tanh</span><span class="o">.</span><span class="n">numpy</span><span class="p">(</span><span class="n">beta</span> <span class="o">*</span> <span class="n">c</span><span class="p">)</span>
        <span class="n">reduction</span> <span class="o">=</span> <span class="n">reduction_op</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="s2">&quot;row&quot;</span><span class="p">,</span> <span class="s2">&quot;Add&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">threadblock_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">D</span><span class="p">,</span> <span class="n">reduction</span>
<span class="n">epilogue_functor</span> <span class="o">=</span> <span class="n">RowReduction_</span><span class="p">(</span>
    <span class="n">epilogue_functor</span><span class="p">,</span> <span class="n">tile_description</span><span class="p">,</span> <span class="n">math_inst</span><span class="o">.</span><span class="n">element_accumulator</span><span class="p">,</span> 
    <span class="n">C</span><span class="o">.</span><span class="n">alignment</span><span class="p">,</span> <span class="n">element_epilogue</span><span class="p">,</span> <span class="n">C</span><span class="o">.</span><span class="n">element</span><span class="p">)</span>
<span class="n">epilogue_functor</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>

<span class="n">cta_n</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">threadblock_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">num_cta_n</span> <span class="o">=</span> <span class="p">(</span><span class="n">problem_size</span><span class="o">.</span><span class="n">n</span><span class="p">()</span> <span class="o">+</span> <span class="n">cta_n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">cta_n</span>
<span class="n">reduction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">batch</span> <span class="o">*</span> <span class="n">problem_size</span><span class="o">.</span><span class="n">m</span><span class="p">()</span> <span class="o">*</span> <span class="n">num_cta_n</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">element_c</span><span class="p">))</span>
<span class="c1"># get output op</span>
<span class="n">output_op</span> <span class="o">=</span> <span class="n">operation</span><span class="o">.</span><span class="n">epilogue_type</span><span class="p">(</span>
    <span class="n">D</span><span class="o">=</span><span class="n">tensor_D</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">beta</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">tensor_C</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="n">reduction</span><span class="p">,</span> <span class="n">problem_size</span><span class="o">=</span><span class="p">[</span><span class="n">problem_size</span><span class="o">.</span><span class="n">m</span><span class="p">(),</span> <span class="n">problem_size</span><span class="o">.</span><span class="n">n</span><span class="p">()]</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Like other epilogue functors such as <code class="docutils literal notranslate"><span class="pre">LinearCombination</span></code>, the output op for EpilogueVisitorTree is also created with <code class="docutils literal notranslate"><span class="pre">operation.epilogue_type(*)</span></code>. However, there are two differences:</p>
<ul class="simple">
<li><p>The arguments need to be passed as keyword-arguments. The keywords are the argument names in <code class="docutils literal notranslate"><span class="pre">def</span> <span class="pre">__call__</span></code>.</p></li>
<li><p>An additional <code class="docutils literal notranslate"><span class="pre">problem_size=[problem_size.m(),</span> <span class="pre">problem_size.n()]</span></code> is required.</p></li>
</ul>
</section>
<section id="add-new-unary-operation-e-g-activation-function">
<h2>Add new Unary Operation (e.g. Activation Function)<a class="headerlink" href="#add-new-unary-operation-e-g-activation-function" title="Permalink to this heading">¶</a></h2>
<p>To add additional unary operation into epilogue visitor tree, a new unary op
should be created for <code class="docutils literal notranslate"><span class="pre">VisitorOpUnary</span></code>. We will take <code class="docutils literal notranslate"><span class="pre">tanh</span></code> as an example.</p>
<section id="step-1-define-tanhvisitor">
<h3>Step 1: define TanhVisitor<a class="headerlink" href="#step-1-define-tanhvisitor" title="Permalink to this heading">¶</a></h3>
<p>The visitor defines the parameters and computation required by the unary option.
The unary operations are registered in <a class="reference external" href="tools/library/scripts/pycutlass/src/cpp/include/epilogue/epilogue_visitor_op/unary_ops.h">pycutlass/src/cpp/include/epilogue/epilogue_visitor_op/unary_ops.h</a>. But you can define it in any header file and include the header file in <a class="reference external" href="tools/library/scripts/pycutlass/src/cpp/include/epilogue/epilogue_visitor_op/visitor_op_unary.h">pycutlass/src/cpp/include/epilogue/epilogue_visitor_op/visitor_op_unary.h</a>.</p>
<ul class="simple">
<li><p>Two template arguments are required:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">T</span></code>: data type used to compute the unary operation</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">N</span></code>: compute fragment length</p></li>
</ul>
</li>
<li><p>We also need to provide the <code class="docutils literal notranslate"><span class="pre">Arguments</span></code> and <code class="docutils literal notranslate"><span class="pre">Params</span></code> structures. The <code class="docutils literal notranslate"><span class="pre">Arguments</span></code> will be assembled by <a class="reference external" href="https://docs.python.org/3/library/ctypes.html">ctypes</a>, the <code class="docutils literal notranslate"><span class="pre">Params</span></code> will be generated from <code class="docutils literal notranslate"><span class="pre">Arguments</span></code> automatically. If the unary function takes no argument, an integer like <code class="docutils literal notranslate"><span class="pre">int</span> <span class="pre">tmp</span></code> can be provide to ensure the correctness of ctypes.</p></li>
<li><p>The constructor can only take the <code class="docutils literal notranslate"><span class="pre">params</span></code> as the single argument.</p></li>
<li><p>The operation is defined in <code class="docutils literal notranslate"><span class="pre">Array&lt;T,</span> <span class="pre">N&gt;</span> <span class="pre">operator()(Array&lt;T,</span> <span class="pre">N&gt;</span> <span class="pre">const</span> <span class="pre">&amp;frag)</span> <span class="pre">const</span> </code>. On common way to do that is first define a scalar computation, and them use it for the fragment computation with an unrolled for-loop.</p></li>
<li><p>A guard function is required. If it returns <code class="docutils literal notranslate"><span class="pre">true</span></code>, it will disable all the children nodes of the unary node and return zeros to parent node. This is very helpful for multiplication with scalar while the scalar is <code class="docutils literal notranslate"><span class="pre">0</span></code>. For general cases, you can just return <code class="docutils literal notranslate"><span class="pre">true</span></code>.</p></li>
</ul>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// T: data type used to compute the unary operation</span>
<span class="c1">// N: compute fragment length</span>
<span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="o">&gt;</span><span class="w"></span>
<span class="k">struct</span><span class="w"> </span><span class="nc">TanhVisitor</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">/// Argument</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">Arguments</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// a placeholder argument to ensure correctness of ctypes</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">tmp</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="n">CUTLASS_HOST_DEVICE</span><span class="w"></span>
<span class="w">        </span><span class="nf">Arguments</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="n">tmp</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">};</span><span class="w"></span>

<span class="w">        </span><span class="n">CUTLASS_HOST_DEVICE</span><span class="w"></span>
<span class="w">        </span><span class="nf">Arguments</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">tmp</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">tmp</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="c1">/// Param</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">Params</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">CUTLASS_HOST_DEVICE</span><span class="w"></span>
<span class="w">        </span><span class="nf">Params</span><span class="p">(){</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">        </span><span class="n">Params</span><span class="p">(</span><span class="n">Arguments</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">&amp;</span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="c1">/// Constructor</span>
<span class="w">    </span><span class="n">CUTLASS_HOST_DEVICE</span><span class="w"></span>
<span class="w">    </span><span class="nf">TanhVisitor</span><span class="p">(</span><span class="n">Params</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">&amp;</span><span class="n">params</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// scalar operator</span>
<span class="w">    </span><span class="n">CUTLASS_HOST_DEVICE</span><span class="w"></span>
<span class="w">    </span><span class="n">T</span><span class="w"> </span><span class="n">tanh_op</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">&amp;</span><span class="n">scalar</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">fast_tanh</span><span class="p">(</span><span class="n">scalar</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">/// vector operator</span>
<span class="w">    </span><span class="n">CUTLASS_HOST_DEVICE</span><span class="w"></span>
<span class="w">    </span><span class="n">Array</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="o">&gt;</span><span class="w"> </span><span class="k">operator</span><span class="p">()(</span><span class="n">Array</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="o">&gt;</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">&amp;</span><span class="n">frag</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Array</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="o">&gt;</span><span class="w"> </span><span class="n">y</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="n">CUTLASS_PRAGMA_UNROLL</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tanh_op</span><span class="p">(</span><span class="n">frag</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">y</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Guard</span>
<span class="w">    </span><span class="n">CUTLASS_HOST_DEVICE</span><span class="w"></span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">guard</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="step-2-register-tanh-function">
<h3>Step 2: register Tanh function<a class="headerlink" href="#step-2-register-tanh-function" title="Permalink to this heading">¶</a></h3>
<p>After defining the function in C++, we need to register it in python. The class below gives an example.</p>
<ul class="simple">
<li><p>The init function takes the data type <code class="docutils literal notranslate"><span class="pre">element_compute</span></code>, which will be the <code class="docutils literal notranslate"><span class="pre">T</span></code> in the C++ template.
In the init function, we also generate the <code class="docutils literal notranslate"><span class="pre">_Arguments</span></code> class as a <code class="docutils literal notranslate"><span class="pre">ctypes.Structure</span></code>. It includes all the data members in the <code class="docutils literal notranslate"><span class="pre">TanhVisitor::Arguments</span></code>.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">_Arguments</span></code> need to be registered as <code class="docutils literal notranslate"><span class="pre">self.argument_type</span></code> of <code class="docutils literal notranslate"><span class="pre">tanh</span></code> class.</p></li>
<li><p>A <code class="docutils literal notranslate"><span class="pre">emit</span></code> function is required to emit the namespace and typename of <code class="docutils literal notranslate"><span class="pre">TanhVisitor</span></code>.</p></li>
<li><p>A staticmethod as numpy reference is required to implement the python code to parse.</p></li>
</ul>
<p>The built-in functions are defined in <a class="reference external" href="tools/library/scripts/pycutlass/src/pycutlass/epilogue.py">pycutlass/src/pycutlass/epilogue.py</a>. You can defined yours in any file as long as it can be found by <a class="reference external" href="tools/library/scripts/pycutlass/src/pycutlass/parser.py">/pycutlass/src/pycutlass/parser.py</a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">tanh</span><span class="p">(</span><span class="n">ActivationFunctor</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element_compute</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="k">class</span> <span class="nc">_Arguments</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">Structure</span><span class="p">):</span>
            <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="s2">&quot;tmp&quot;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">argument_type</span> <span class="o">=</span> <span class="n">_Arguments</span>
    
    <span class="k">def</span> <span class="nf">emit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;cutlass::TanhVisitor&quot;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">numpy</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="step-3-run-the-function">
<h3>Step 3: Run the function<a class="headerlink" href="#step-3-run-the-function" title="Permalink to this heading">¶</a></h3>
<p>Now the new unary op is ready to use. An epilogue visitor tree can be built with</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">RowReduction_</span><span class="p">(</span><span class="n">EpilogueVisitTree</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">accum</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="s1">&#39;tensor&#39;</span><span class="p">,</span> <span class="s1">&#39;float32&#39;</span><span class="p">],</span>  <span class="n">c</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="s1">&#39;tensor&#39;</span><span class="p">,</span> <span class="s1">&#39;float32&#39;</span><span class="p">],</span> 
        <span class="n">alpha</span><span class="p">:</span> <span class="s1">&#39;float32&#39;</span><span class="p">,</span> <span class="n">beta</span><span class="p">:</span> <span class="s1">&#39;float32&#39;</span><span class="p">):</span>
        <span class="c1">#</span>
        <span class="n">D</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">accum</span> <span class="o">+</span> <span class="n">tanh</span><span class="o">.</span><span class="n">numpy</span><span class="p">(</span><span class="n">beta</span> <span class="o">*</span> <span class="n">c</span><span class="p">)</span>
        <span class="n">reduction</span> <span class="o">=</span> <span class="n">reduction_op</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="s2">&quot;row&quot;</span><span class="p">,</span> <span class="s2">&quot;Add&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">threadblock_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">D</span><span class="p">,</span> <span class="n">reduction</span>
<span class="n">epilogue_functor</span> <span class="o">=</span> <span class="n">RowReduction_</span><span class="p">(</span>
    <span class="n">epilogue_functor</span><span class="p">,</span> <span class="n">tile_description</span><span class="p">,</span> <span class="n">math_inst</span><span class="o">.</span><span class="n">element_accumulator</span><span class="p">,</span> 
    <span class="n">C</span><span class="o">.</span><span class="n">alignment</span><span class="p">,</span> <span class="n">element_epilogue</span><span class="p">,</span> <span class="n">C</span><span class="o">.</span><span class="n">element</span><span class="p">)</span>
<span class="n">epilogue_functor</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>
<section id="limitations-and-future-work">
<h2>Limitations and Future work<a class="headerlink" href="#limitations-and-future-work" title="Permalink to this heading">¶</a></h2>
<p>Although the Epilogue Visitor Tree brings great flexibility to epilogue construction, as the epilogue is formulated as a single tree, there are several limitations.</p>
<ul class="simple">
<li><p>[Future Work] Serial and Parallel Split-K GEMM are not supported yet.</p>
<ul>
<li><p>To support serial split-k, additional tree transformation pass is required to inject a <code class="docutils literal notranslate"><span class="pre">binaryOpNode(Add)</span></code> + <code class="docutils literal notranslate"><span class="pre">TensorInputNode</span></code> before each <code class="docutils literal notranslate"><span class="pre">TensorOutputNode</span></code> to fetch the partial sum back. The <code class="docutils literal notranslate"><span class="pre">semaphore</span></code> also needs to be passed into epilogue.</p></li>
<li><p>To support parallel split-k, an Reduction with visitor kernel is required.</p></li>
</ul>
</li>
<li><p>[Future Work] Convolution and GEMM Grouped are not supported yet.</p>
<ul>
<li><p>To support Conv2d and GEMM Grouped, corresponding *_with_visitor kernels are required.</p></li>
</ul>
</li>
<li><p>[Limitation] If the same node is used by two operations (except that one of them is reduction), the node and all its offsprings will be executed twice.</p></li>
<li><p>[Limitation] The result of reduction can only be used as the return value.</p></li>
</ul>
</section>
</section>


                        
                    </div>
                </div>
            </div>
        </div>
    </div>    


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../../../../../../../../../',
            VERSION:'1.0.0',
            LANGUAGE:'en',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
    <script type="text/javascript" src="../../../../../../../../../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../../../../../../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../../../../../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../../../../../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script type="text/javascript" src="../../../../../../../../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../../../../../../../../../_static/sphinx_highlight.js"></script>
    <script type="text/javascript" src="../../../../../../../../../../../_static/clipboard.min.js"></script>
    <script type="text/javascript" src="../../../../../../../../../../../_static/copybutton.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script type="text/javascript" src="../../../../../../../../../../../_static/js/theme.js"></script>
  
    <div class="footer" role="contentinfo">
        <div class="container">
            &#169; Copyright bladedisc-dev@list.alibaba-inc.com.
        Created using <a href="http://sphinx-doc.org/">Sphinx</a> 5.3.0.
        </div>
    </div>  

</body>
</html>